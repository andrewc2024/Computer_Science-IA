const firebaseConfig = {
  // Add your own personal project config
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
var storageRef = firebase.storage().ref();

const userID = localStorage.getItem("userID");
document.getElementById("post").addEventListener("click", addTextbook, false);

var selectedFile; // Stores file user wants to upload

// Once the user selects a file from the dropdown menu, keep a reference of it
// so that it can be uploaded to the database.
document.getElementById("image").addEventListener(
  "change",
  () => {
    selectedFile = document.getElementById("image").files[0];
    console.log(selectedFile);
  },
  false
);

// Generate a User ID randomly
// Note that this implementation is relatively simplistic.
// In the extremely rare case where an ID collision takes place,
// the user will have to re-register.
// The maximum number of users is 10 billion
function generateID() {
  return Math.round(Math.random() * 10000000000);
}

// This function is called once the user clicks the 'Add textbook' button
function addTextbook() {
  // Prevent the user from spamming the button and causing issues
  document.getElementById("post").disabled = true;

  // If there is no image for the textbook, prompt the user to upload one
  if (selectedFile == null) {
    window.alert("Please upload an image of your textbook!");
    return;
  }

  // Uploads the image to the database under a unique ID
  var uploadTask = storageRef
    .child(generateID() + "." + selectedFile.type.split("/").pop())
    .put(selectedFile);
  var imageURL;

  uploadTask.on(
    "state_changed",
    (snapshot) => { // Log progress of upload
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      console.log("Upload is " + progress + "% done");
      switch (snapshot.state) {
        case firebase.storage.TaskState.PAUSED:
          console.log("Upload is paused");
          break;
        case firebase.storage.TaskState.RUNNING:
          console.log("Upload is running");
          break;
      }
    },
    (error) => {
      console.log(error);
    },
    () => {
      uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
        console.log("File available at", downloadURL);
        imageURL = downloadURL;

        // Once receiving the image's link in our database,
        // create the textbook object with relevant fields.
        // Note that this object can be modified to include other fields
        let textbook = {
          name: document.getElementById("name").value,
          description: document.getElementById("description").value,
          price: document.getElementById("price").value,
          yearLevel: document.getElementById("yearLevel").value,
          subject: document.getElementById("subject").value,
          subjectLevel: document.getElementById("subjectLevel").value,
          donate: document.getElementById("donate").ariaChecked,
          sold: false,
          vendor: userID,
          numRatings: 0,
          numStars: 0,
          dateAdded: new Date(),
          image: imageURL,
        };

        // Add the textbook to the database
        db.collection("textbooks")
          .add(textbook)
          .then((d) => {
            // Update textbookid field of the textbook to its id (which is generated by the database)
            db.collection("textbooks").doc(d.id).update({ textbookid: d.id });
            textbook.textbookid = d.id;

            // File a reference of the textbook under the user's listing
            // This information is used in the profile page where users can access their listings
            db.collection("users")
              .doc(userID)
              .get()
              .then((u) => {
                let listings = u.data().listings;
                listings.push(textbook.textbookid);

                db.collection("users").doc(userID).update({
                  listings: listings,
                }).then(() => {
                  // Alert the user that they have successfully added a textbook
                  // This alert also delays the redirect until the upload has been complete
                  window.alert("Successfully added!");
                  window.location.href = "/public/shoppingPage.html";
                });
              })
              .catch((error) => {
                console.error("Error: ", error);
              });
          })
          .catch((error) => {
            console.error("Error adding document: ", error);
          });
      });
    }
  );
}
